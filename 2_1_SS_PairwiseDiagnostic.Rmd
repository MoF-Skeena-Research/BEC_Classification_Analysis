---
title: "Pairwise_Diagnostic"
author: "WH MacKenzie"
date: "08/01/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(reshape2)
require(plyr)
require(dplyr)
require(tidyr)
require(ggplot2)
require(magrittr)
require(foreach)
require(tcltk)
require(openxlsx)
require(doParallel)
require(doBy)
require(doParallel)
require(DBI)
require(data.table)
require(labdsv)
require(tidyverse)
source("./_functions/_lump_species.R")
source("./_functions/_create_su_vegdata.R")
source("./_functions/_create_analysis_vegsum.R")
source("./_functions/_TabletoTree.R")
source("./_functions/_TreetoTable.R")
source("./_functions/_add_vars.R")

```

## Read in data and sorts and spp lumping

```{r load data}
# load(file = "./clean_data/SS_sum_analysis_data.RData")
# 
# xx <- readRDS("./report_material/examplevegsum.rds" )
# xx <- as.data.frame(xx[[1]])
# xx <- as.data.frame(xx[[2]]) %>% mutate(n = xx[[1]]$n)

veg.dat <- readRDS("./clean_data/Analysis_BECMaster_Veg.rds") ###named veg.dat


master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
DBQ=D:/GitHub/BEC_Classification_Analysis/Vpro/Coast_Skunkcabbage.accdb;")
su <- dbReadTable(master_su, "AllBGC_Skunkcabbage_SU")
dbDisconnect(master_su)

# master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
# DBQ=D:/BC_Correlation2_Vpro_2023/working/All_Skunkcabbage.accdb;")
# su <- dbReadTable(master_su, "AllBGC_Skunkcabbage_SU")
# dbDisconnect(master_su)

# master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
# DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Hierarchy.accdb;")
# su <- dbReadTable(master_su, "All_Coast_Forest_SU")
# dbDisconnect(master_su)
su$SiteUnit.orig <- su$SiteUnit
su <- su %>% mutate(SiteUnit = gsub("/", "_", su$SiteUnit)) 
su <- su %>% mutate(SiteUnit = gsub(" ", "", su$SiteUnit, fixed = TRUE)) 
su.lookup <- su
su <- su %>% select(-SiteUnit.orig)

su <- su %>% 
  filter(!str_detect(SiteUnit, '[$]')) %>% filter(!str_detect(SiteUnit, "^x"))

sppmaster <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=F:/OneDrive - Personal/OneDrive/BCSpeciesList/SpeciesTaxonomyMaster.accdb;")
taxon.all  <- dbReadTable(sppmaster, "USysAllSpecs")
dbDisconnect(sppmaster)
taxon.lifeform <- taxon.all %>% filter(Codetype == "U" |Codetype == "X") %>% dplyr::select(Code, ScientificName, EnglishName, Lifeform) %>% distinct

veglump <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Spp_lump.accdb;")
lump <- dbReadTable(veglump, "CoastGuide2023_Lump")
dbDisconnect(veglump) 

veg.dat2 <- lump_species(veg.dat, lump)
trees = c(1, 2)
#veg.dat2 <- veg.dat2 %>% filter(!Lifeform %in% trees)
```

## Settings for pairwise
```{r}
##create function for diagnostic value
## for convert data in comparisons
sig.classes = c(0,1,2,3,4,5,6,7,8,9)
sig.class.cuts <- c(.1, .3, 2.2, 5, 10, 20, 33, 50, 75)
## function to convert summary data into classes
pres.class <- c(.2, .4, .6, .8)
## function to convert constancy into classes

## for categorization in pair-wise comparison
high_cons_cut = 57
dom = 10
minor = 1
##pair.wise. constancy difference cut points
const_cut = c( 37, 57, 77, 100)
const_cut2 = c(-100,-77, -57, -37)
const_labels = c("d3", "d2", "d1")
const_labels2 = c("d1", "d2", "d3")

# const_cut = c(40, 60, 80, 100)
# const_cut2 = c(-100,-80, -60, -40)
# const_labels = c("d3", "d2", "d1")
# const_labels2 = c("d1", "d2", "d3")


  d1 = .77
  d2 = .57
  d3 = .37
  cd = 6 ##sig. class
  ## c will be >cm and <cd
  cm = 1
  
 ## pair.wise.scores
  d1 = 4
  d2 = 3
  d3 = 1
  no_d = 0

cov_cut = c(.1, .3, 2.2, 5, 10, 20, 33, 50, 75, 100)
cov_labels = c(1,2,3,4,5,6,7,8,9)

    dd1 = 4
  dd2 = 3
  dd3 = 2
  dd4 = 1
  c = 0
  cd = 0
  cm = -2
  
d_dd = 1.25
reduced.lifeform = c(8, 9, 10, 11)
reduced.diag = .1
round = 1
exclude = 1

key.site.indicators <- c("LYSIAME", "OPLOHOR", "ATHYFIL")
key.moss.indicators <- c("SPHAGNUM", "CLADONIA")
ksi.value = 2
  
```

## Calculate constancy and mean cover
use the create_analysis_vegsum function
then
calulate type (c or cd) DONE
add in lifeform to species and n plots (comes from create_su_vegdata function) DONE
Calculate potential differential sum

```{r settings, echo=FALSE}

vegsum <- create_su_vegdata(veg.dat2,su) %>% create_analysis_vegsum(minimportance = 0.5, minconstancy = .6, noiseconstancy = 0, minplots = 5, covadj = 1)
  
vegsum <- vegsum %>% rowwise() %>% mutate(constant_type = ifelse((Constancy >=high_cons_cut & MeanCov >=dom), "cd",
                                                   ifelse((Constancy >=high_cons_cut & MeanCov <= minor), "cm",
                                                                           ifelse(Constancy >=high_cons_cut, "c", NA))))


###Calculate diagnostic potential

vegsum <- vegsum %>% mutate(diagnostic.potential = ifelse((Constancy >= high_cons_cut & MeanCov >=dom), ((d1+dd1)*1.25)*(Constancy/100), 
                                                  ifelse(Constancy >= high_cons_cut, d1 *(Constancy/100), 0)))

vegsum2 <- left_join(vegsum, taxon.lifeform, by = c("Species" = "Code")) %>% 
  mutate(diagnostic.potential = ifelse(Lifeform %in% reduced.lifeform, (diagnostic.potential  * reduced.diag),diagnostic.potential))

vegsum <- vegsum %>% mutate(diagnostic.potential = ifelse(Species %in% key.site.indicators, diagnostic.potential * ksi.value,diagnostic.potential))
                                              
vegsum <- vegsum2 %>% dplyr::group_by(SiteUnit) %>% mutate(unit.diag.sum = sum(diagnostic.potential)) %>% select(-Lifeform)

units.low.diagnostics <- vegsum %>% select(SiteUnit, unit.diag.sum) %>% distinct %>%  filter(unit.diag.sum < 50) #%>% distinct(PlotNumber)
```

## Pairwise comparison
use combn function to create pairs
create loop that creates comparison for each pair in the comb list
full_join of unit 1 and unit2 from summary
then apply rules to generate compared diagnostic values by species for each pair
compare covers and convert difference into cover class
compare constancy and convert distance into constancy class
assign points based on constancy and cover rules
ratio of potential differential vs actual
flag units with high ratios for possible amalgamation
```{r the data.table version}
require(tictoc)
tic()
pairs <- unique(vegsum$SiteUnit) %>% combn(m=2) %>% t %>% data.frame %>% dplyr::rename(Unit1 = 1, Unit2 = 2) %>% arrange(Unit1)
pairs <- expand.grid(x = unique(vegsum$SiteUnit), y= unique(vegsum$SiteUnit) ) %>%  dplyr::rename(Unit1 = 1, Unit2 = 2)
pair = pairs#[1,]
# pairs$val <- 0.5
# pair.tst <- pairs %>% pivot_wider(id_cols=Unit1, names_from = Unit2, values_from = val)
vegsum.pairs1 <- left_join(pair, vegsum, by = c("Unit1" = "SiteUnit"))
vegsum.pairs2 <- left_join(pair, vegsum, by = c("Unit2" = "SiteUnit")) 
vegsum.pairs <- full_join(vegsum.pairs1, vegsum.pairs2, by = c("Unit1", "Unit2", "Species"))%>% mutate_if(is.numeric, replace_na, replace = 0)
vegsum.pairs <- left_join(vegsum.pairs, taxon.lifeform, by = c("Species" = "Code"))

setDT(vegsum.pairs)[, c("cov.diff", "const.diff") := .(MeanCov.x - MeanCov.y, Constancy.x - Constancy.y)]
setkey(vegsum.pairs, "Unit1", "Unit2", "Species")

vegsum.pairs[, `:=`(
  shared.diag = pmin(diagnostic.potential.x, diagnostic.potential.y, na.rm = TRUE)
), by = .(Unit1, Unit2, Species)]


# Differential

vegsum.temp = vegsum.pairs
vegsum.pairs[, d.type.x := cut(const.diff, breaks = const_cut, labels = const_labels)]
vegsum.pairs[, d.type.y := cut(const.diff, breaks = const_cut2, labels = const_labels2)]
library(data.table)

# Assuming vegsum.pairs is a data.table
vegsum.pairs[, d.type.x := ifelse(Constancy.x < high_cons_cut, NA, paste0("",d.type.x))]
vegsum.pairs[, d.type.y := ifelse(Constancy.y < high_cons_cut, NA, paste0("",d.type.y))]

   ### d points                           
vegsum.pairs[, c("d.points.x", "d.points.y") := .(
  ifelse(d.type.x %in% "d1", 4,
         ifelse(d.type.x %in% "d2", 3,
                ifelse(d.type.x %in% "d3", 1, NA_real_))),
  ifelse(d.type.y %in% "d1", 4,
         ifelse(d.type.y %in% "d2", 3,
                ifelse(d.type.y %in% "d3", 1, NA_real_)))
)]  

dom.hi = 10
dom.lo = 5
####Unit1 dd points
vegsum.pairs[, `:=`(
  cover.pts.x = ifelse(MeanCov.x >= dom.hi, MeanCov.x / MeanCov.y / 10,
                       ifelse(MeanCov.x < dom.hi & MeanCov.x >= dom.lo, MeanCov.x / (MeanCov.y * 1.5) / 10, 0)))]
 vegsum.pairs[, `:=`( 
  cover.pts.x = ifelse(cover.pts.x > 1, 1,
                       ifelse(cover.pts.x < 0.2, 0, cover.pts.x)))]#,
  vegsum.pairs[, `:=`(  
  dd.pts.x = ifelse(MeanCov.x >= dom.hi, (cover.pts.x * 4),
                    ifelse(MeanCov.x < dom.hi & MeanCov.x > dom.lo, ((cover.pts.x * 4) / (MeanCov.x / 10)), 0))
)]


vegsum.pairs[, dd.type.x := fifelse((dd.pts.x >=4) & (constant_type.x == "cd"), "dd1",
                    fifelse((dd.pts.x <4 & dd.pts.x >=2) &(constant_type.x == "cd"), "dd2",
                           fifelse((dd.pts.x >=1.2 & dd.pts.x <2) &(constant_type.x == "cd"), "dd3",
                                  fifelse((dd.pts.x >0 & dd.pts.x <1.2) &(constant_type.x == "cd"), "dd4", NA_character_))))]
xx <- vegsum.pairs %>% filter(Unit1 == "CWHms2_103" , Unit2 == "CWHws2_103" )          
yy <- vegsum.pairs %>% filter(Unit1 == "CWHms4_116(Ws56.2)", Unit2 == "CWHms1_114(Ws56.1)" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))

###Unit2 dd points
vegsum.pairs[, `:=`(
  cover.pts.y = ifelse(MeanCov.y >= dom.hi, MeanCov.y / MeanCov.x / 10,
                       ifelse(MeanCov.y < dom.hi & MeanCov.y >= dom.lo, MeanCov.y / (MeanCov.x * 1.5) / 10, 0)))]
 vegsum.pairs[, `:=`( 
  cover.pts.y = ifelse(cover.pts.y > 1, 1,
                       ifelse(cover.pts.y < 0.2, 0, cover.pts.y)))]
vegsum.pairs[, `:=`(  
  dd.pts.y = ifelse(MeanCov.y >= dom.hi, (cover.pts.y * 4),
                    ifelse(MeanCov.y < dom.hi & MeanCov.y > dom.lo, (cover.pts.y * 4) / (MeanCov.y / 10), 0))
)]


vegsum.pairs[, dd.type.y := fifelse((dd.pts.y >=4) & (constant_type.y == "cd"), "dd1",
                    fifelse((dd.pts.y <4 & dd.pts.y >=2) &(constant_type.y == "cd"), "dd2",
                           fifelse((dd.pts.y >=1.2 & dd.pts.y <2) &(constant_type.y == "cd"), "dd3",
                                  fifelse((dd.pts.y >0 & dd.pts.y <1.2) &(constant_type.y == "cd"), "dd4", NA_character_))))]


vegsum.pairs[, `:=`(
  dd.points.x = ifelse(dd.type.x %in% "dd1", 4,
                       ifelse(dd.type.x %in% "dd2", 3,
                              ifelse(dd.type.x %in% "dd3", 2,
                                     ifelse(dd.type.x %in% "dd4", 1, NA_real_)))),
  dd.points.y = ifelse(dd.type.y %in% "dd1", 4,
                       ifelse(dd.type.y %in% "dd2", 3,
                              ifelse(dd.type.y %in% "dd3", 2,
                                     ifelse(dd.type.y %in% "dd4", 1, NA_real_))))
)]

#xx <- vegsum.pairs %>% filter(Unit1 == "CWHms1_114(Ws56.1)" , Unit2 == "CWHms4_116(Ws56.2)" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))
yy <- vegsum.pairs %>% filter(Unit1 == "CWHms4_116(Ws56.2)", Unit2 == "CWHms1_114(Ws56.1)" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))


# Adjust points for moss layer

vegsum.pairs[, `:=`(
  d.points.x = ifelse(Lifeform %in% reduced.lifeform, d.points.x * 0.1, d.points.x),
  d.points.y = ifelse(Lifeform %in% reduced.lifeform, d.points.y * 0.1, d.points.y),
  dd.points.x = ifelse(Lifeform %in% reduced.lifeform, dd.points.x * 0.1, dd.points.x),
  dd.points.y = ifelse(Lifeform %in% reduced.lifeform, dd.points.y * 0.1, dd.points.y)
)]

# Sum sum of diagnostic differentials by species
setkey(vegsum.pairs, "Unit1", "Unit2", "Species")

### adjust points for constancy
vegsum.pairs[, `:=`(
  diag.points.x = sum(d.points.x, dd.points.x, na.rm = TRUE) * (Constancy.x / 100),
  diag.points.y = sum(d.points.y, dd.points.y, na.rm = TRUE) * (Constancy.y / 100)
), by = .(Unit1, Unit2, Species)]

## adjust ponits for being d as well as dd
vegsum.pairs[, `:=`(
  diag.points.x = ifelse((!is.na(d.type.x) & !is.na(dd.type.x)), (diag.points.x * 1.25), diag.points.x),
  diag.points.y = ifelse((!is.na(d.type.y) & !is.na(dd.type.y)), (diag.points.y * 1.25), diag.points.y)
), by = .(Unit1, Unit2, Species)]

## adjust points for key indicators
vegsum.pairs[, `:=`(
  diag.points.x = ifelse(Species %in% key.site.indicators, (diag.points.x * ksi.value), diag.points.x),
  diag.points.y = ifelse(Species %in% key.site.indicators, (diag.points.x * ksi.value), diag.points.y)
), by = .(Unit1, Unit2, Species)]
## adjust points for key moss layer indicators
vegsum.pairs[, `:=`(
  diag.points.x = ifelse(Species %in% key.moss.indicators, (diag.points.x * (3/reduced.lifeform)), diag.points.x),
  diag.points.y = ifelse(Species %in% key.moss.indicators, (diag.points.x * (3/reduced.lifeform)), diag.points.y)
), by = .(Unit1, Unit2, Species)]

# Sums by pair
vegsum.pairs[, `:=`(
  sum.shared.diag = sum(shared.diag),
  diag.tot.x = sum(diag.points.x, na.rm = TRUE),
  diag.tot.y = sum(diag.points.y, na.rm = TRUE)
), by = .(Unit1, Unit2)]


vegsum.pairs[ ,diag.tot :=rowSums(.SD, na.rm = TRUE), .SDcols = c("diag.tot.x", "diag.tot.y" ), by = .(Unit1, Unit2)]

vegsum.pairs[, `:=`(
  diag.potential.tot = sum(max(diagnostic.potential.x), max(diagnostic.potential.y, na.rm = TRUE)),
  diag.ratio = sum.shared.diag / (diag.tot + sum.shared.diag)
), by = .(Unit1, Unit2)]
# Ungroup the data.table
vegsum.pairs <- vegsum.pairs[, .SD, .SDcols = names(vegsum.pairs)]
toc()
```


```{r look for very similar site u}
xx <- vegsum.pairs %>% filter(Unit1 == "CWHms1_114(Ws56.1)" , Unit2 == "CWHms4_116(Ws56.2)" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))
yy <- vegsum.pairs %>% filter(Unit2 == "CWHms1_114(Ws56.1)" , Unit1 == "CWHms4_116(Ws56.2)" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))
xx <- xx %>%  select(Unit1, Unit2, Species, Constancy.x, MeanCov.x, d.type.x, dd.points.x, dd.type.x, diag.points.x,  Constancy.y, MeanCov.y, d.type.y, dd.points.y, dd.type.y, diag.points.y,  diag.tot, diag.ratio, diag.potential.tot) %>% data.frame %>% mutate_if(is.numeric, ~format(round(., digits=2), nsmall = 2))

library(data.table)

# Assuming vegsum.pairs is a data.table
setkey(vegsum.pairs, "Unit1", "Unit2")

vegsum.pairs.report <- vegsum.pairs[
  ,
  .(Unit1, Unit2, Species, Constancy.x, MeanCov.x, d.type.x, dd.type.x, diag.points.x,
    Constancy.y, MeanCov.y, d.type.y, dd.type.y, diag.points.y, sum.shared.diag,
    diag.tot, diag.ratio, unit.diag.sum.x, unit.diag.sum.y)
]

# Format numeric columns
# numeric_cols <- names(vegsum.pairs.report)[sapply(vegsum.pairs.report, is.numeric)]
# vegsum.pairs.report[, (numeric_cols) := lapply(.SD, function(x) format(round(x, digits = 2), nsmall = 2)), .SDcols = numeric_cols]

# vegsum.pairs.report.sum <- vegsum.pairs.report %>% select (Unit1, Unit2, sum.shared.diag, diag.tot, diag.ratio) %>% distinct
# xx <- vegsum.pairs %>% filter(Unit1 == "CWHvm1_101" , Unit2 == "CWHvm3_101" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))

vegsum.pairs.report.sum <- vegsum.pairs.report %>% select (Unit1, Unit2, sum.shared.diag, diag.tot, diag.ratio, unit.diag.sum.x, unit.diag.sum.y) %>%
      distinct %>% data.frame %>% mutate(diss = 1-diag.ratio)

##remove units 
removed.units = c("MHmm2_114(SMR6)", "CWHwh1_118", "CWHwh1_118.3", "CWHvh3_117" )
vegsum.pairs.report.sum <-  vegsum.pairs.report.sum %>% filter(!Unit1 %in% removed.units, !Unit2 %in% removed.units)
su.similar <- vegsum.pairs.report.sum %>% dplyr::filter(diag.ratio >.8)#diag.tot <10 & 

# vegs.anal1 <- vegsum.pairs.report.sum %>% select(Unit1,Unit2, diag.ratio) %>% distinct %>% arrange(Unit1)
# vegsum.anal2 <- vegsum.pairs.report.sum %>% select(Unit1,Unumit2, diag.ratio) %>% distinct %>% rename(Unit2 = Unit1, Unit1 = Unit2)%>% arrange(Unit1)
dis.matrix <- vegsum.pairs.report.sum %>% select(Unit1,Unit2, diss) %>% distinct %>% arrange(Unit1) %>% pivot_wider(id_cols = Unit1, names_from = Unit2, values_from = diss) %>% column_to_rownames("Unit1") %>% as.matrix

 library(cluster)
require(ape)
require(factoextra)
ss_clst = agnes(dis.matrix , diss = TRUE, stand = FALSE,
      method = "complete")



dendro_hc <- as.hclust(ss_clst)
fviz_dend(dendro_hc, cex = 1, lwd = 0.25, h = .25, 
          rect = TRUE, 
          k_colors = "jco", 
          rect_border = "black", 
          rect_fill = TRUE,
          horiz = TRUE,
          ggtheme = theme_gray(),labels=F)

working <- cutree(h = .1, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Working = ".") %>% mutate(Working = paste0("working-", Working))
assoc <- cutree(h = .25, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Assoc = ".") %>% mutate(Assoc = paste0("assoc-", Assoc))
alliance <- cutree(h = .5, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Alliance = ".")%>% mutate(Alliance = paste0("all-", Alliance))
order <- cutree(h = .99, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Order = ".")%>% mutate(Order = paste0("ord-", Order))
suborder <- cutree(h = .94, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Suborder = ".")%>% mutate(Suborder = paste0("subord-", Suborder))
clst.units <- left_join(order,suborder, by = "SiteUnit") %>%
                    left_join(alliance, by = "SiteUnit") %>%
                    left_join(assoc, by = "SiteUnit") %>%
                    left_join(working, by = "SiteUnit") %>%
                    arrange(SiteUnit) %>% rowid_to_column("ID") %>%
                    mutate(Formation = "", Class = "forest", Suball = "", Subass = "", Faces = "")%>%
                    left_join(su.lookup) %>% select(-SiteUnit) %>%  rename(SiteUnit = SiteUnit.orig)  %>%
                    select(ID, Formation, Class, Order, Suborder, Alliance, Suball, Assoc, Faces, Working, SiteUnit) %>% as.data.table




```


###Import Vpro hierarchy and turn to widematrix
```{r convert into a hierarchy table}
levelNames <- c("Formation", "Class", "Order", "Suborder", "Alliance", "Suball", "Assoc", "Subass", "Facies", "Working", "SiteUnit")
new.hier <- tableToTree(clst.units, levelNames = levelNames) %>% as.data.frame

fwrite(new.hier, "./hierarchy_to_vpro/newhierarchyfromcluster_v1.csv")
# require(DBI)
# hierarchy <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Hierarchy.accdb;")
# Vpro.hier <- dbWriteTable(hierarchy, "ForestsforCluster_v2023_2_Hierarchy", new.hier)
# dbDisconnect(hierarchy)
# source("./_functions/_TreetoTable.R")
# SUhier <- treeToTable(Vpro.hier)
# Hier.clean <- SUhier$table
# Hier.new <- Hier.clean[1, ] 
# Hier.new <- Hier.new[-1, ] 
# Hier.new$SiteUnit <- working$SiteUnit


```





###Abandoned approach

```{r build set for cluster}
###build dataset for cluster
veg.anal <- vegsum.pairs[, .(Unit1, Unit2, Species, diagnostic.potential.x, diagnostic.potential.y)]

veg.anal[, value.x := ifelse((diagnostic.potential.x > 0 & diagnostic.potential.y > 0),
                           pmin(diagnostic.potential.x, diagnostic.potential.y),
                           ifelse((diagnostic.potential.x > 0 | diagnostic.potential.y == 0),
                                  pmax(diagnostic.potential.x, diagnostic.potential.y),
                                  0))]
veg.anal[, value.y := ifelse((diagnostic.potential.x > 0 & diagnostic.potential.y > 0),
                           pmin(diagnostic.potential.x, diagnostic.potential.y),
                           ifelse((diagnostic.potential.y > 0 | diagnostic.potential.x == 0),
                                  pmax(diagnostic.potential.x, diagnostic.potential.y),
                                  0))]

veg.anal2 <- veg.anal %>% filter(value.x > 0 | value.y > 0)
veg.test <- veg.anal2 %>% mutate(compareSU = paste0(Unit1, "vs", Unit2))
veg.compare.x <- veg.test %>% dplyr::select(compareSU, Unit1, Species, value.x ) %>% rename(SiteUnit = Unit1, value = value.x)
veg.compare.y <- veg.test %>% select(compareSU,Unit2, Species, value.y) %>% rename(SiteUnit = Unit2, value = value.y)
veg.compare <- rbind(veg.compare.x, veg.compare.y) %>% filter(value > 0) %>% mutate(compareSU = as.factor(compareSU))
unit.list <- veg.compare %>% distinct(compareSU) 


veg.dist <- foreach(x = unit.list, .combine = 'rbind', .packages = c('vegan', 'dplyr', 'labdsv', 'tidyr', 'tibble')) %do% {
  compare1 <- veg.compare %>% filter(compareSU %in% x)
  compare.name <- compare1[1]
    compare1 <- compare1 %>% select(-1) %>% matrify
test_jac.vegan <- vegan::vegdist(compare1, method = "bray", binary = F) %>% as.matrix(labels = TRUE) %>% data.frame %>% rownames_to_column("Unit1") %>% pivot_longer(-Unit1, names_to = "Unit2", values_to = "value")
test_jac.vegan
}
toc()
similar.units <- veg.dist %>% filter(value <0.1 & value>0)

dis.matrix <- veg.dist %>% pivot_wider(id_cols = Unit1, names_from = Unit2, values_from = value) %>% column_to_rownames("Unit1") %>% as.matrix

```

Use agnes algorithms to build bottom-up hierarchy. Cutting the dendrogram at a low dissimilarity threshold (0.25) seems to make good working groups that pass the second pair-wise test. However, the structure of the higher level groups seems odd in some cases where similar site series end up in very different upper units.
Might need to develop an alternative grouping mechanism
```{r cluster and cut - standard algorithms}
#ss_clst <- hclust(test_jac, method = "complete")
library(cluster)
require(ape)
require(factoextra)
ss_clst = agnes(dis.matrix , diss = TRUE, stand = FALSE,
      method = "complete")

xx <- cutree(h = .1, ss_clst) %>% data.frame %>% rownames_to_column("SiteUnit")

dendro_hc <- as.hclust(ss_clst)
fviz_dend(dendro_hc, cex = 0.5, lwd = 0.5, h = .1, 
          rect = TRUE, 
          k_colors = "jco", 
          rect_border = "black", 
          rect_fill = TRUE,
          ggtheme = theme_gray(),labels=F)

```

```{r the tidy verse version}
# require(tictoc)
# tic()
# pairs <- unique(vegsum$SiteUnit) %>% combn(m=2) %>% t %>% data.frame %>% dplyr::rename(Unit1 = 1, Unit2 = 2)
# pair = pairs#[1,]
# 
# vegsum.pairs1 <- left_join(pair, vegsum, by = c("Unit1" = "SiteUnit"))
# vegsum.pairs2 <- left_join(pair, vegsum, by = c("Unit2" = "SiteUnit")) 
# vegsum.pairs <- full_join(vegsum.pairs1, vegsum.pairs2, by = c("Unit1", "Unit2", "Species"))%>% mutate_if(is.numeric, replace_na, replace = 0)
# vegsum.pairs <- left_join(vegsum.pairs, taxon.lifeform, by = c("Species" = "Code"))
# # 
# # filter(!is.na(Unit1), !is.na(Unit2))
# vegsum.pairs <- vegsum.pairs %>% mutate(cov.diff = MeanCov.x - MeanCov.y, const.diff  = Constancy.x-Constancy.y) %>% rowwise() %>%
#   mutate(shared.diag = min(diagnostic.potential.x, diagnostic.potential.y, na.rm=TRUE))
# 
# ##differential
# vegsum.pairs$d.type.x <- cut(vegsum.pairs$const.diff, const_cut, labels = const_labels)
# vegsum.pairs$d.type.y <- cut(vegsum.pairs$const.diff, const_cut2, labels = const_labels2)
# 
# vegsum.pairs <- vegsum.pairs %>% mutate(d.points.x = ifelse(d.type.x %in% "d1", 4,
#                     ifelse(d.type.x %in% "d2", 3,
#                            ifelse(d.type.x %in% "d3", 1, NA)))) %>%
#                   mutate(d.points.y = ifelse(d.type.y %in% "d1", 4,
#                     ifelse(d.type.y %in% "d2", 3,
#                            ifelse(d.type.y %in% "d3", 1, NA))))
# 
# 
# ##dominant differ
# #vegsum.pairs$sig.diff <- cut(vegsum.pairs$cov.diff, cov_cut)#, labels = cov_labels) %>% as.numeric
# vegsum.pairs$sig.x <- cut(vegsum.pairs$MeanCov.x, cov_cut, labels = cov_labels) %>% as.numeric
# vegsum.pairs$sig.y <- cut(vegsum.pairs$MeanCov.y, cov_cut, labels = cov_labels) %>% as.numeric
# vegsum.pairs <- vegsum.pairs %>% mutate(dd.diff = sum(sig.x, (sig.y * -1), na.rm=TRUE))
# 
# 
# vegsum.pairs <- vegsum.pairs %>% mutate(dd.type.x = ifelse((dd.diff  >= 4 & MeanCov.x >= dom), "dd1",
#                     ifelse((dd.diff  >= 3 & MeanCov.x >= dom), "dd2",
#                            ifelse((dd.diff  >= 2 & MeanCov.x >= dom), "dd3",
#                                   ifelse((dd.diff  >= 1 & MeanCov.x >= dom), "dd4", NA))))) %>%
#                 mutate(dd.type.y = ifelse((dd.diff  <= -4 & MeanCov.y >= dom), "dd1",
#                     ifelse((dd.diff  <= -3 & MeanCov.y >= dom), "dd2",
#                            ifelse((dd.diff  <= -2 & MeanCov.y >= dom), "dd3",
#                                   ifelse((dd.diff  <= -1 & MeanCov.y >= dom), "dd4", NA)))))
# # toc()
# 
# 
# 
# 
# vegsum.pairs <- vegsum.pairs %>% mutate(dd.points.x = ifelse(dd.type.x %in% "dd1", 4,
#                     ifelse(dd.type.x %in% "dd2", 3,
#                            ifelse(dd.type.x %in% "dd3", 2,
#                                   ifelse(dd.type.x %in% "dd4", 1, NA))))) %>%
#                   mutate(dd.points.y = ifelse(dd.type.y %in% "dd1", 4,
#                     ifelse(dd.type.y %in% "dd2", 3,
#                            ifelse(dd.type.y %in% "dd3", 2,
#                                   ifelse(dd.type.y %in% "dd4", 1, NA)))))
# 
# # ##adjust points for moss layer
# vegsum.pairs <- vegsum.pairs %>% mutate(d.points.x = ifelse(Lifeform %in% reduced.lifeform, d.points.x * 0.1, d.points.x)) %>%
#   mutate(d.points.y = ifelse(Lifeform %in% reduced.lifeform, d.points.y * 0.1, d.points.y)) %>%
#   mutate(dd.points.x = ifelse(Lifeform %in% reduced.lifeform, dd.points.x * 0.1, dd.points.x)) %>%
#   mutate(dd.points.y = ifelse(Lifeform %in% reduced.lifeform, dd.points.y * 0.1, dd.points.y))
# 
# ## sum sum of diagnostic differentials by species
# vegsum.pairs <- vegsum.pairs %>% rowwise() %>% mutate(diag.points.x = sum(d.points.x, dd.points.x, na.rm=TRUE)*(Constancy.x/100)) %>%
#   mutate(diag.points.y = sum(d.points.y, dd.points.y, na.rm=TRUE)*(Constancy.y/100)) %>%
#     mutate(diag.points.x = ifelse((!is.na(d.type.x) & !is.na(dd.type.x)),(diag.points.x * 1.25), diag.points.x )) %>%
#   mutate(diag.points.y = ifelse((!is.na(d.type.y) & !is.na(dd.type.y)),(diag.points.y * 1.25), diag.points.y ))
# ## sums by pair
# vegsum.pairs <- vegsum.pairs %>% group_by(Unit1, Unit2)%>% mutate(sum.shared.diag = sum(shared.diag)) %>% mutate(diag.tot.x = max(unit.diag.sum.x, na.rm=TRUE)) %>%
#   mutate(diag.tot.y = max(unit.diag.sum.y, na.rm=TRUE)) %>% mutate(diag.tot = sum(diag.points.x, diag.points.y, na.rm=TRUE)) %>%
#   mutate(diag.potential.tot = sum(max(unit.diag.sum.x), max(unit.diag.sum.y, na.rm = TRUE))) %>% mutate(diag.ratio = diag.tot/(diag.tot+sum.shared.diag)) %>% ungroup
# 
# 
# # 
# vegsum.pairs.report <- vegsum.pairs %>% ungroup  %>% select(Unit1, Unit2, Species, Constancy.x, MeanCov.x, d.type.x, dd.type.x, diag.points.x,  Constancy.y, MeanCov.y, d.type.y, dd.type.y, diag.points.y, sum.shared.diag, diag.tot, diag.ratio, diag.potential.tot) %>% data.frame %>% mutate_if(is.numeric, ~format(round(., digits=2), nsmall = 2))
# 
# xx <- vegsum.pairs %>% filter(Unit1 == "CWH vm 1 /101" , Unit2 == "CWH vm 1 /103" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))
# 
# vegsum.pairs.report.sum <- vegsum.pairs.report %>% select (Unit1, Unit2, sum.shared.diag, diag.tot, diag.ratio, diag.potential.tot) %>% distinct #%>% filter(diag.ratio >.75)
# toc()

##176 secs to run
```



