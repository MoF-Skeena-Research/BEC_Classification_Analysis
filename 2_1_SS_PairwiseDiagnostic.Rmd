---
title: "Pairwise_Diagnostic"
author: "WH MacKenzie"
date: "08/01/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(reshape2)
require(plyr)
require(dplyr)
require(tidyr)
require(ggplot2)
require(magrittr)
require(foreach)
require(tcltk)
require(openxlsx)
require(doParallel)
require(doBy)
require(doParallel)
require(DBI)
require(data.table)
require(labdsv)
require(tidyverse)
library(cluster)
require(ape)
require(factoextra)
require(tictoc)
source("./_functions/_lump_species.R")
source("./_functions/_create_su_vegdata.R")
source("./_functions/_create_analysis_vegsum.R")
source("./_functions/_TabletoTree.R")
source("./_functions/_TreetoTable.R")
source("./_functions/_add_vars.R")
source("./_functions/_do_pairwise.R")
source("./_functions/_create_diagnostic_veg.R")
source("./_functions/_return_similar_pairs.R")
```

## Read in data and sorts and spp lumping

```{r load data}
veg.dat <- readRDS("./clean_data/Analysis_BECMaster_Veg.rds") ###named veg.dat


master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
DBQ=D:/GitHub/BEC_Classification_Analysis/Vpro/Coast_Skunkcabbage.accdb;")
su <- dbReadTable(master_su, "AllBGC_Skunkcabbage_SU")
dbDisconnect(master_su)

master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
DBQ=D:/BC_Correlation2_Vpro_2023/All_BC_Correlation.accdb;")
su <- dbReadTable(master_su, "All_BC_BGCs_SU")
dbDisconnect(master_su)

master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Hierarchy.accdb;")
su <- dbReadTable(master_su, "All_CoastForest_v2024_SU")
dbDisconnect(master_su)


su$SiteUnit.orig <- su$SiteUnit
su <- su %>% mutate(SiteUnit = gsub("/", "_", su$SiteUnit)) 
su <- su %>% mutate(SiteUnit = gsub(" ", "", su$SiteUnit, fixed = TRUE)) 
su.lookup <- su
su <- su %>% select(-SiteUnit.orig)
su <- su %>% 
  filter(!str_detect(SiteUnit, '[$]')) %>% filter(!str_detect(SiteUnit, "^x"))

sppmaster <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=F:/OneDrive - Personal/OneDrive/BCSpeciesList/SpeciesTaxonomyMaster.accdb;")
taxon.all  <- dbReadTable(sppmaster, "USysAllSpecs")
dbDisconnect(sppmaster)
taxon.lifeform <- taxon.all %>% filter(Codetype == "U" |Codetype == "X") %>% dplyr::select(Code, ScientificName, EnglishName, Lifeform) %>% distinct

 trees = c(1, 2)
# veg.dat2 <- veg.dat %>% filter(Lifeform %in% trees)


veglump <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Spp_lump.accdb;")
lump <- dbReadTable(veglump, "CoastGuide2023_Lump")
dbDisconnect(veglump)

veg.dat2 <- lump_species(veg.dat, lump)

veg.dat2 <- veg.dat
```

## Settings diagnostic categories, thresholds and points
```{r}
## for categorization in pair-wise comparison
high_cons_cut = 57 ## cut-off for inclusion as constant species for unit
dom = 10## minimum % cover for constant dominant
minor = 1 ## maximum %cover threshold for constant minor 
##pair.wise. constancy difference cut points for differential significance
const_cut = c( 37, 57, 77, 100)
const_cut2 = c(-100,-77, -57, -37)
const_labels = c("d3", "d2", "d1")
const_labels2 = c("d1", "d2", "d3")

 ## base pair.wise.scores for differential species categores
  d1 = 4; d2 = 3; d3 = 1;   no_d = 0
##pair.wise. constancy difference cut points for dominant differential significance
cov_cut = c(.1, .3, 2.2, 5, 10, 20, 33, 50, 75, 100)
cov_labels = c(1,2,3,4,5,6,7,8,9)

dd1 = 4; dd2 = 3;   dd3 = 2;   dd4 = 1

d_dd = 1.25 ## multiplier if species is both d and dd
 ## number of decimal places to show
#exclude = 1 ##
```

## Look for units with low diagnostic potential

```{r settings, echo=FALSE}

# key.site.indicators <- c("LYSIAME", "OPLOHOR", "ATHYFIL", "TSUGMER", "THUJPLI", "SPHAGNUM", "CLADONIA")
# ksi.value = 2
# 
# vegsum <- create_diagnostic_veg(veg.dat2, su, minimportance = 0.5, minconstancy = .6, noiseconstancy = .2, minplots = 5, covadj = 1, use.ksi = TRUE, ksi = key.site.indicators, ksi.value = 2, reduce.lifeform = TRUE, reduced.lifeforms = reduced.lifeform, reduction = reduced.diag)
# units.low.diagnostics <- vegsum %>% select(SiteUnit, unit.diag.sum) %>% distinct %>%  filter(unit.diag.sum < 40) #%>% distinct(PlotNumber)
```

## Pairwise comparison
use combn function to create pairs
create loop that creates comparison for each pair in the comb list
full_join of unit 1 and unit2 from summary
then apply rules to generate compared diagnostic values by species for each pair
compare covers and convert difference into cover class
compare constancy and convert distance into constancy class
assign points based on constancy and cover rules
ratio of potential differential vs actual
flag units with high ratios for possible amalgamation
```{r the data.table version}

##"LYSIAME", "OPLOHOR", "ATHYFIL", "SPHAGNUM", "CLADONIA"

key.site.indicators <- c("TSUGMER") ## priorities for zonal comparison, "THUJPLI", "TSUGHET", "RHODALB", "CALARUB"
ksi.value = 2

reduced.lifeform = c(3,4,5,6,7,8, 9, 10, 11, 12)## reduce diagnostic value of lifeforms for zonal comparison
reduced.lifeform = c(8, 9, 10, 11)## reduce diagnostic value of lifeforms for association development
reduce.multiplier = .1
round = 1
tic()
###select units to run
su2 <- su %>% filter(!grepl('CWHvh3|CWHwh1|CWHwh2|ICHvc', SiteUnit))###BGC specific
su2 <- su2 %>% filter(grepl('01', SiteUnit)) %>%  filter(!grepl('101.2|101a.2|101b.2|101b', SiteUnit))
###zonal specific
vegsum.pairs <- do_pairwise(veg.dat2, su2, minimportance = 0.5, minconstancy = .6, noiseconstancy = .2, minplots = 5, covadj = 1, 
                            use.ksi = TRUE, ksi = key.site.indicators, ksi.value = ksi.value, reduce.lifeform = TRUE, reduced.lifeforms = reduced.lifeform, reduction = reduced.multiplier)
toc()
## Sometimes units get placed in odd places in the cluster analsysis because very similar similarity
## Check here. Probably indicates site unit membership to be fixed.
su.similar <- return_similar_pairs(vegsum.pairs, similarity = .90, neighbours = 3) 

#su.similar <- vegsum.pairs %>% select(Unit1, Unit2, diag.ratio) %>% dplyr::filter(diag.ratio > .9) %>% filter(!Unit1 == Unit2)  %>%  distinct
```


```{r cluster analysis}

dis.matrix <- as.data.frame(vegsum.pairs) %>% mutate(diss = 1-diag.ratio) %>% mutate(Unit1 = as.character(Unit1)) %>%  select(Unit1,Unit2, diss) %>% distinct %>% arrange(Unit1) %>% pivot_wider(id_cols = Unit1, names_from = Unit2, values_from = diss) %>% arrange(Unit1) %>%  column_to_rownames("Unit1") %>% mutate_all(~replace(., is.na(.), 1))%>% as.matrix

ss_clst = agnes(dis.matrix , diss = TRUE, stand = FALSE,
      method = "complete")

dendro_hc <- as.hclust(ss_clst)
fviz_dend(dendro_hc, cex = .6, lwd = 0.25, h = .4, 
          rect = TRUE, 
          k_colors = "jco", 
          rect_border = "black", 
          rect_fill = TRUE,
          #lower_rect = -.2,
          #horiz = TRUE,
          ggtheme = theme_gray(),labels=F)

working <- cutree(h = .1, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Working = ".") %>% mutate(Working = paste0("working-", Working))
assoc <- cutree(h = .25, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Assoc = ".") %>% mutate(Assoc = paste0("assoc-", Assoc))
alliance <- cutree(h = .7, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Alliance = ".")%>% mutate(Alliance = paste0("all-", Alliance))
order <- cutree(h = .99, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Order = ".")%>% mutate(Order = paste0("ord-", Order))
suborder <- cutree(h = .94, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Suborder = ".")%>% mutate(Suborder = paste0("subord-", Suborder))
clst.units <- left_join(order,suborder, by = "SiteUnit") %>%
                    left_join(alliance, by = "SiteUnit") %>%
                    left_join(assoc, by = "SiteUnit") %>%
                    left_join(working, by = "SiteUnit") %>%
                    arrange(SiteUnit) %>% rowid_to_column("ID") %>%
                    mutate(Formation = "", Class = "forest", Suball = "", Subass = "", Faces = "")%>%
                    left_join(su.lookup) %>% select(-SiteUnit) %>%  rename(SiteUnit = SiteUnit.orig)  %>%
                    select(ID, Formation, Class, Order, Suborder, Alliance, Suball, Assoc, Faces, Working, SiteUnit) %>% as.data.table


assoc.count <- assoc %>% count(Assoc)
alliance.count <- alliance %>% count(Alliance)
order.count <- order %>% count(Order)

```


###Import Vpro hierarchy and turn to widematrix write cluster membership into hierarchy
```{r convert into a hierarchy table}
levelNames <- c("Formation", "Class", "Order", "Suborder", "Alliance", "Suball", "Assoc", "Subass", "Facies", "Working", "SiteUnit")
new.hier <- tableToTree(clst.units, levelNames = levelNames) %>% as.data.frame

fwrite(new.hier, "./hierarchy_to_vpro/newhierarchyfromcluster_v1.csv")
```






