---
title: "Pairwise_Diagnostic"
author: "WH MacKenzie"
date: "08/01/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(reshape2)
require(plyr)
require(dplyr)
require(tidyr)
require(ggplot2)
require(magrittr)
require(foreach)
require(tcltk)
require(openxlsx)
require(doParallel)
require(doBy)
require(doParallel)
require(DBI)
require(data.table)
require(labdsv)
require(tidyverse)
library(cluster)
require(ape)
require(factoextra)
require(tictoc)
source("./_functions/_lump_species.R")
source("./_functions/_create_su_vegdata.R")
source("./_functions/_create_analysis_vegsum.R")
source("./_functions/_TabletoTree.R")
source("./_functions/_TreetoTable.R")
source("./_functions/_add_vars.R")
source("./_functions/_do_pairwise.R")
source("./_functions/_create_diagnostic_veg.R")
source("./_functions/_return_similar_pairs.R")
```

## Read in data and sorts and spp lumping

```{r load data}
veg.dat <- readRDS("./clean_data/Analysis_BECMaster_Veg.rds") ###named veg.dat


master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
DBQ=D:/GitHub/BEC_Classification_Analysis/Vpro/Coast_Skunkcabbage.accdb;")
su <- dbReadTable(master_su, "AllBGC_Skunkcabbage_SU")
dbDisconnect(master_su)

master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
DBQ=D:/BC_Correlation2_Vpro_2023/All_BC_Correlation.accdb;")
su <- dbReadTable(master_su, "All_BC_BGCs_SU")
dbDisconnect(master_su)

master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)};
DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Hierarchy.accdb;")
su <- dbReadTable(master_su, "All_CoastForest_v2024_SU")
dbDisconnect(master_su)


su$SiteUnit.orig <- su$SiteUnit
su <- su %>% mutate(SiteUnit = gsub("/", "_", su$SiteUnit)) 
su <- su %>% mutate(SiteUnit = gsub(" ", "", su$SiteUnit, fixed = TRUE)) 
su.lookup <- su
su <- su %>% select(-SiteUnit.orig)
su <- su %>% 
  filter(!str_detect(SiteUnit, '[$]')) %>% filter(!str_detect(SiteUnit, "^x"))

sppmaster <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=F:/OneDrive - Personal/OneDrive/BCSpeciesList/SpeciesTaxonomyMaster.accdb;")
taxon.all  <- dbReadTable(sppmaster, "USysAllSpecs")
dbDisconnect(sppmaster)
taxon.lifeform <- taxon.all %>% filter(Codetype == "U" |Codetype == "X") %>% dplyr::select(Code, ScientificName, EnglishName, Lifeform) %>% distinct

 trees = c(1, 2)
# veg.dat2 <- veg.dat %>% filter(Lifeform %in% trees)


veglump <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Spp_lump.accdb;")
lump <- dbReadTable(veglump, "CoastGuide2023_Lump")
dbDisconnect(veglump)

veg.dat2 <- lump_species(veg.dat, lump)

veg.dat2 <- veg.dat
```

## Settings diagnostic categories, thresholds and points
```{r}
## for categorization in pair-wise comparison
high_cons_cut = 57 ## cut-off for inclusion as constant species for unit
dom = 10## minimum % cover for constant dominant
minor = 1 ## maximum %cover threshold for constant minor 
##pair.wise. constancy difference cut points for differential significance
const_cut = c( 37, 57, 77, 100)
const_cut2 = c(-100,-77, -57, -37)
const_labels = c("d3", "d2", "d1")
const_labels2 = c("d1", "d2", "d3")

 ## base pair.wise.scores for differential species categores
  d1 = 4; d2 = 3; d3 = 1;   no_d = 0
##pair.wise. constancy difference cut points for dominant differential significance
cov_cut = c(.1, .3, 2.2, 5, 10, 20, 33, 50, 75, 100)
cov_labels = c(1,2,3,4,5,6,7,8,9)

dd1 = 4; dd2 = 3;   dd3 = 2;   dd4 = 1

d_dd = 1.25 ## multiplier if species is both d and dd
 ## number of decimal places to show
#exclude = 1 ##
```

## Look for units with low diagnostic potential

```{r settings, echo=FALSE}

# key.site.indicators <- c("LYSIAME", "OPLOHOR", "ATHYFIL", "TSUGMER", "THUJPLI", "SPHAGNUM", "CLADONIA")
# ksi.value = 2
# 
# vegsum <- create_diagnostic_veg(veg.dat2, su, minimportance = 0.5, minconstancy = .6, noiseconstancy = .2, minplots = 5, covadj = 1, use.ksi = TRUE, ksi = key.site.indicators, ksi.value = 2, reduce.lifeform = TRUE, reduced.lifeforms = reduced.lifeform, reduction = reduced.diag)
# units.low.diagnostics <- vegsum %>% select(SiteUnit, unit.diag.sum) %>% distinct %>%  filter(unit.diag.sum < 40) #%>% distinct(PlotNumber)
```

## Pairwise comparison
use combn function to create pairs
create loop that creates comparison for each pair in the comb list
full_join of unit 1 and unit2 from summary
then apply rules to generate compared diagnostic values by species for each pair
compare covers and convert difference into cover class
compare constancy and convert distance into constancy class
assign points based on constancy and cover rules
ratio of potential differential vs actual
flag units with high ratios for possible amalgamation
```{r the data.table version}

##"LYSIAME", "OPLOHOR", "ATHYFIL", "SPHAGNUM", "CLADONIA"

key.site.indicators <- c("TSUGMER") ## priorities for zonal comparison, "THUJPLI", "TSUGHET", "RHODALB", "CALARUB"
ksi.value = 2

reduced.lifeform = c(3,4,5,6,7,8, 9, 10, 11, 12)## reduce diagnostic value of lifeforms for zonal comparison
reduced.lifeform = c(8, 9, 10, 11)## reduce diagnostic value of lifeforms for association development
reduce.multiplier = .1
round = 1
tic()
###select units to run
su2 <- su %>% filter(!grepl('CWHvh3|CWHwh1|CWHwh2|ICHvc', SiteUnit))###BGC specific
su2 <- su2 %>% filter(grepl('01', SiteUnit)) %>%  filter(!grepl('101.2|101a.2|101b.2|101b', SiteUnit))
###zonal specific
vegsum.pairs <- do_pairwise(veg.dat2, su2, minimportance = 0.5, minconstancy = .6, noiseconstancy = .2, minplots = 5, covadj = 1, 
                            use.ksi = TRUE, ksi = key.site.indicators, ksi.value = ksi.value, reduce.lifeform = TRUE, reduced.lifeforms = reduced.lifeform, reduction = reduced.multiplier)
toc()
## Sometimes units get placed in odd places in the cluster analsysis because very similar similarity
## Check here. Probably indicates site unit membership to be fixed.
su.similar <- return_similar_pairs(vegsum.pairs, similarity = .90, neighbours = 3) 

#su.similar <- vegsum.pairs %>% select(Unit1, Unit2, diag.ratio) %>% dplyr::filter(diag.ratio > .9) %>% filter(!Unit1 == Unit2)  %>%  distinct
```


```{r cluster analysis}

dis.matrix <- as.data.frame(vegsum.pairs) %>% mutate(diss = 1-diag.ratio) %>% mutate(Unit1 = as.character(Unit1)) %>%  select(Unit1,Unit2, diss) %>% distinct %>% arrange(Unit1) %>% pivot_wider(id_cols = Unit1, names_from = Unit2, values_from = diss) %>% arrange(Unit1) %>%  column_to_rownames("Unit1") %>% mutate_all(~replace(., is.na(.), 1))%>% as.matrix

ss_clst = agnes(dis.matrix , diss = TRUE, stand = FALSE,
      method = "complete")

dendro_hc <- as.hclust(ss_clst)
fviz_dend(dendro_hc, cex = .6, lwd = 0.25, h = .4, 
          rect = TRUE, 
          k_colors = "jco", 
          rect_border = "black", 
          rect_fill = TRUE,
          #lower_rect = -.2,
          #horiz = TRUE,
          ggtheme = theme_gray(),labels=F)

working <- cutree(h = .1, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Working = ".") %>% mutate(Working = paste0("working-", Working))
assoc <- cutree(h = .25, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Assoc = ".") %>% mutate(Assoc = paste0("assoc-", Assoc))
alliance <- cutree(h = .7, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Alliance = ".")%>% mutate(Alliance = paste0("all-", Alliance))
order <- cutree(h = .99, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Order = ".")%>% mutate(Order = paste0("ord-", Order))
suborder <- cutree(h = .94, dendro_hc) %>% data.frame %>% rownames_to_column("SiteUnit") %>% rename(Suborder = ".")%>% mutate(Suborder = paste0("subord-", Suborder))
clst.units <- left_join(order,suborder, by = "SiteUnit") %>%
                    left_join(alliance, by = "SiteUnit") %>%
                    left_join(assoc, by = "SiteUnit") %>%
                    left_join(working, by = "SiteUnit") %>%
                    arrange(SiteUnit) %>% rowid_to_column("ID") %>%
                    mutate(Formation = "", Class = "forest", Suball = "", Subass = "", Faces = "")%>%
                    left_join(su.lookup) %>% select(-SiteUnit) %>%  rename(SiteUnit = SiteUnit.orig)  %>%
                    select(ID, Formation, Class, Order, Suborder, Alliance, Suball, Assoc, Faces, Working, SiteUnit) %>% as.data.table


assoc.count <- assoc %>% count(Assoc)
alliance.count <- alliance %>% count(Alliance)
order.count <- order %>% count(Order)

```


###Import Vpro hierarchy and turn to widematrix write cluster membership into hierarchy
```{r convert into a hierarchy table}
levelNames <- c("Formation", "Class", "Order", "Suborder", "Alliance", "Suball", "Assoc", "Subass", "Facies", "Working", "SiteUnit")
new.hier <- tableToTree(clst.units, levelNames = levelNames) %>% as.data.frame

fwrite(new.hier, "./hierarchy_to_vpro/newhierarchyfromcluster_v1.csv")
# require(DBI)
# hierarchy <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Hierarchy.accdb;")
# Vpro.hier <- dbWriteTable(hierarchy, "ForestsforCluster_v2023_2_Hierarchy", new.hier)
# dbDisconnect(hierarchy)
# source("./_functions/_TreetoTable.R")
# SUhier <- treeToTable(Vpro.hier)
# Hier.clean <- SUhier$table
# Hier.new <- Hier.clean[1, ] 
# Hier.new <- Hier.new[-1, ] 
# Hier.new$SiteUnit <- working$SiteUnit


```





###Abandoned approach

```{r build set for cluster}
###build dataset for cluster
veg.anal <- vegsum.pairs[, .(Unit1, Unit2, Species, diagnostic.potential.x, diagnostic.potential.y)]

veg.anal[, value.x := ifelse((diagnostic.potential.x > 0 & diagnostic.potential.y > 0),
                           pmin(diagnostic.potential.x, diagnostic.potential.y),
                           ifelse((diagnostic.potential.x > 0 | diagnostic.potential.y == 0),
                                  pmax(diagnostic.potential.x, diagnostic.potential.y),
                                  0))]
veg.anal[, value.y := ifelse((diagnostic.potential.x > 0 & diagnostic.potential.y > 0),
                           pmin(diagnostic.potential.x, diagnostic.potential.y),
                           ifelse((diagnostic.potential.y > 0 | diagnostic.potential.x == 0),
                                  pmax(diagnostic.potential.x, diagnostic.potential.y),
                                  0))]

veg.anal2 <- veg.anal %>% filter(value.x > 0 | value.y > 0)
veg.test <- veg.anal2 %>% mutate(compareSU = paste0(Unit1, "vs", Unit2))
veg.compare.x <- veg.test %>% dplyr::select(compareSU, Unit1, Species, value.x ) %>% rename(SiteUnit = Unit1, value = value.x)
veg.compare.y <- veg.test %>% select(compareSU,Unit2, Species, value.y) %>% rename(SiteUnit = Unit2, value = value.y)
veg.compare <- rbind(veg.compare.x, veg.compare.y) %>% filter(value > 0) %>% mutate(compareSU = as.factor(compareSU))
unit.list <- veg.compare %>% distinct(compareSU) 


veg.dist <- foreach(x = unit.list, .combine = 'rbind', .packages = c('vegan', 'dplyr', 'labdsv', 'tidyr', 'tibble')) %do% {
  compare1 <- veg.compare %>% filter(compareSU %in% x)
  compare.name <- compare1[1]
    compare1 <- compare1 %>% select(-1) %>% matrify
test_jac.vegan <- vegan::vegdist(compare1, method = "bray", binary = F) %>% as.matrix(labels = TRUE) %>% data.frame %>% rownames_to_column("Unit1") %>% pivot_longer(-Unit1, names_to = "Unit2", values_to = "value")
test_jac.vegan
}
toc()
similar.units <- veg.dist %>% filter(value <0.1 & value>0)

dis.matrix <- veg.dist %>% pivot_wider(id_cols = Unit1, names_from = Unit2, values_from = value) %>% column_to_rownames("Unit1") %>% as.matrix

```

Use agnes algorithms to build bottom-up hierarchy. Cutting the dendrogram at a low dissimilarity threshold (0.25) seems to make good working groups that pass the second pair-wise test. However, the structure of the higher level groups seems odd in some cases where similar site series end up in very different upper units.
Might need to develop an alternative grouping mechanism
```{r cluster and cut - standard algorithms}
#ss_clst <- hclust(test_jac, method = "complete")
library(cluster)
require(ape)
require(factoextra)
ss_clst = agnes(dis.matrix , diss = TRUE, stand = FALSE,
      method = "complete")

xx <- cutree(h = .1, ss_clst) %>% data.frame %>% rownames_to_column("SiteUnit")

dendro_hc <- as.hclust(ss_clst)
fviz_dend(dendro_hc, cex = 0.5, lwd = 0.5, h = .25, 
          rect = TRUE, 
          k_colors = "jco", 
          rect_border = "black", 
          rect_fill = TRUE,
          ggtheme = theme_gray(),labels=F)

```

```{r the tidy verse version}
# require(tictoc)
# tic()
# pairs <- unique(vegsum$SiteUnit) %>% combn(m=2) %>% t %>% data.frame %>% dplyr::rename(Unit1 = 1, Unit2 = 2)
# pair = pairs#[1,]
# 
# vegsum.pairs1 <- left_join(pair, vegsum, by = c("Unit1" = "SiteUnit"))
# vegsum.pairs2 <- left_join(pair, vegsum, by = c("Unit2" = "SiteUnit")) 
# vegsum.pairs <- full_join(vegsum.pairs1, vegsum.pairs2, by = c("Unit1", "Unit2", "Species"))%>% mutate_if(is.numeric, replace_na, replace = 0)
# vegsum.pairs <- left_join(vegsum.pairs, taxon.lifeform, by = c("Species" = "Code"))
# # 
# # filter(!is.na(Unit1), !is.na(Unit2))
# vegsum.pairs <- vegsum.pairs %>% mutate(cov.diff = MeanCov.x - MeanCov.y, const.diff  = Constancy.x-Constancy.y) %>% rowwise() %>%
#   mutate(shared.diag = min(diagnostic.potential.x, diagnostic.potential.y, na.rm=TRUE))
# 
# ##differential
# vegsum.pairs$d.type.x <- cut(vegsum.pairs$const.diff, const_cut, labels = const_labels)
# vegsum.pairs$d.type.y <- cut(vegsum.pairs$const.diff, const_cut2, labels = const_labels2)
# 
# vegsum.pairs <- vegsum.pairs %>% mutate(d.points.x = ifelse(d.type.x %in% "d1", 4,
#                     ifelse(d.type.x %in% "d2", 3,
#                            ifelse(d.type.x %in% "d3", 1, NA)))) %>%
#                   mutate(d.points.y = ifelse(d.type.y %in% "d1", 4,
#                     ifelse(d.type.y %in% "d2", 3,
#                            ifelse(d.type.y %in% "d3", 1, NA))))
# 
# 
# ##dominant differ
# #vegsum.pairs$sig.diff <- cut(vegsum.pairs$cov.diff, cov_cut)#, labels = cov_labels) %>% as.numeric
# vegsum.pairs$sig.x <- cut(vegsum.pairs$MeanCov.x, cov_cut, labels = cov_labels) %>% as.numeric
# vegsum.pairs$sig.y <- cut(vegsum.pairs$MeanCov.y, cov_cut, labels = cov_labels) %>% as.numeric
# vegsum.pairs <- vegsum.pairs %>% mutate(dd.diff = sum(sig.x, (sig.y * -1), na.rm=TRUE))
# 
# 
# vegsum.pairs <- vegsum.pairs %>% mutate(dd.type.x = ifelse((dd.diff  >= 4 & MeanCov.x >= dom), "dd1",
#                     ifelse((dd.diff  >= 3 & MeanCov.x >= dom), "dd2",
#                            ifelse((dd.diff  >= 2 & MeanCov.x >= dom), "dd3",
#                                   ifelse((dd.diff  >= 1 & MeanCov.x >= dom), "dd4", NA))))) %>%
#                 mutate(dd.type.y = ifelse((dd.diff  <= -4 & MeanCov.y >= dom), "dd1",
#                     ifelse((dd.diff  <= -3 & MeanCov.y >= dom), "dd2",
#                            ifelse((dd.diff  <= -2 & MeanCov.y >= dom), "dd3",
#                                   ifelse((dd.diff  <= -1 & MeanCov.y >= dom), "dd4", NA)))))
# # toc()
# 
# 
# 
# 
# vegsum.pairs <- vegsum.pairs %>% mutate(dd.points.x = ifelse(dd.type.x %in% "dd1", 4,
#                     ifelse(dd.type.x %in% "dd2", 3,
#                            ifelse(dd.type.x %in% "dd3", 2,
#                                   ifelse(dd.type.x %in% "dd4", 1, NA))))) %>%
#                   mutate(dd.points.y = ifelse(dd.type.y %in% "dd1", 4,
#                     ifelse(dd.type.y %in% "dd2", 3,
#                            ifelse(dd.type.y %in% "dd3", 2,
#                                   ifelse(dd.type.y %in% "dd4", 1, NA)))))
# 
# # ##adjust points for moss layer
# vegsum.pairs <- vegsum.pairs %>% mutate(d.points.x = ifelse(Lifeform %in% reduced.lifeform, d.points.x * 0.1, d.points.x)) %>%
#   mutate(d.points.y = ifelse(Lifeform %in% reduced.lifeform, d.points.y * 0.1, d.points.y)) %>%
#   mutate(dd.points.x = ifelse(Lifeform %in% reduced.lifeform, dd.points.x * 0.1, dd.points.x)) %>%
#   mutate(dd.points.y = ifelse(Lifeform %in% reduced.lifeform, dd.points.y * 0.1, dd.points.y))
# 
# ## sum sum of diagnostic differentials by species
# vegsum.pairs <- vegsum.pairs %>% rowwise() %>% mutate(diag.points.x = sum(d.points.x, dd.points.x, na.rm=TRUE)*(Constancy.x/100)) %>%
#   mutate(diag.points.y = sum(d.points.y, dd.points.y, na.rm=TRUE)*(Constancy.y/100)) %>%
#     mutate(diag.points.x = ifelse((!is.na(d.type.x) & !is.na(dd.type.x)),(diag.points.x * 1.25), diag.points.x )) %>%
#   mutate(diag.points.y = ifelse((!is.na(d.type.y) & !is.na(dd.type.y)),(diag.points.y * 1.25), diag.points.y ))
# ## sums by pair
# vegsum.pairs <- vegsum.pairs %>% group_by(Unit1, Unit2)%>% mutate(sum.shared.diag = sum(shared.diag)) %>% mutate(diag.tot.x = max(unit.diag.sum.x, na.rm=TRUE)) %>%
#   mutate(diag.tot.y = max(unit.diag.sum.y, na.rm=TRUE)) %>% mutate(diag.tot = sum(diag.points.x, diag.points.y, na.rm=TRUE)) %>%
#   mutate(diag.potential.tot = sum(max(unit.diag.sum.x), max(unit.diag.sum.y, na.rm = TRUE))) %>% mutate(diag.ratio = diag.tot/(diag.tot+sum.shared.diag)) %>% ungroup
# 
# 
# # 
# vegsum.pairs.report <- vegsum.pairs %>% ungroup  %>% select(Unit1, Unit2, Species, Constancy.x, MeanCov.x, d.type.x, dd.type.x, diag.points.x,  Constancy.y, MeanCov.y, d.type.y, dd.type.y, diag.points.y, sum.shared.diag, diag.tot, diag.ratio, diag.potential.tot) %>% data.frame %>% mutate_if(is.numeric, ~format(round(., digits=2), nsmall = 2))
# 
# xx <- vegsum.pairs %>% filter(Unit1 == "CWH vm 1 /101" , Unit2 == "CWH vm 1 /103" ) %>% filter(!is.na(constant_type.x) | !is.na(constant_type.y))
# 
# vegsum.pairs.report.sum <- vegsum.pairs.report %>% select (Unit1, Unit2, sum.shared.diag, diag.tot, diag.ratio, diag.potential.tot) %>% distinct #%>% filter(diag.ratio >.75)
# toc()

##176 secs to run
```



