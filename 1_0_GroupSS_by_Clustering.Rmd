---
title: "Check SUs and prepare summarized vegetation data by site units"
author: "Will MacKenzie"
date: "13/09/2021"
output: html_document
---

```{r setup, include=FALSE}
require(data.table)
require(tidyverse)
require(dplyr)
require(data.tree)
require(DBI) #loads odbc as well
require(labdsv)
require(factoextra)
require(CooccurrenceAffinity)
source("./_functions/_TreetoTable.R")
source("./_functions/_TabletoTree.R")
```

#### Import all raw vpro tables in /raw_data folder
```{r set folders, include=FALSE}
load("./clean_data/veg_plot_data.RData")

becmaster <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BECMaster19/BECMaster19.accdb;")
ENV <- dbReadTable(becmaster, "BECMaster19_Env") %>% mutate(Longitude = ifelse(Longitude<0, Longitude, 0-Longitude))
ADMIN<- dbReadTable(becmaster, "BECMaster19_Admin")
env.fields <- colnames(ENV)
odbc::odbcListColumns(becmaster, table = "BECMaster19_ENV")
dbDisconnect(becmaster)

# master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; 
# DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Hierarchy.accdb;")
# SU <- dbReadTable(master_su, "All_Coast_Forest_SU")
# dbDisconnect(master_su)
###created in 0_0_Plot_SU_Hierarchy checks script
master_su <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; 
DBQ=D:/BC_Correlation2_Vpro_2023/SIFR_Hierarchy.accdb;")
SU <- dbReadTable(master_su, "All_SIFR_Forest_SU")
dbDisconnect(master_su)

veglump <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Spp_Lump.accdb;")
LUMP <- dbReadTable(veglump, "CoastGuide2023_Lump")
dbDisconnect(veglump) 
```


## Import SU table and BECdb for current BGC units and site series. Look for missing units. Create complete SU 

```{r import SU tables and look for errors}
# require(DBI) #loads odbc as well
# correlation <- dbConnect(odbc::odbc(), .connection_string = "Driver={Microsoft Access Driver (*.mdb, *.accdb)}; DBQ=D:/BC_Correlation2_Vpro_2023/CoastGuide_Forested.accdb;")
# all_su <- lapply(setNames(nm = (dbListTables(correlation)%>% str_subset("_SU"))), dbReadTable, conn = correlation)
# dbDisconnect(correlation)
# SU <- do.call(rbind.data.frame, all_su)
# SU <- SU %>% mutate(bgc = substr(SiteUnit,1,9)) %>% drop_na() %>% distinct()
# fwrite(SU, "./clean_tabs/CoastGuide_All_BGC_Forest_SU.csv")
###remove phases and seral units
SU_siteseries <- SU %>% 
  filter(!str_detect(SiteUnit, '[$]'))
phases = c("a", "b", "c")
SU_siteseries$SiteUnit <- str_replace(SU_siteseries$SiteUnit, "[abc]", "")
fwrite(SU_siteseries, "./clean_tabs/CoastGuide_All_BGC_Forest_SS.csv")

SU <- SU_siteseries
###Check that there is plot data for all
missingplots <- anti_join(SU, ENV)
plots <- right_join(SU, ENV)
### Check for duplicate plot usage
usemorethanone <- SU %>% dplyr::group_by(PlotNumber) %>% dplyr::mutate(dups = n()) %>% filter(dups >1) %>% ungroup() %>% arrange(PlotNumber)
fwrite(usemorethanone, "./outputs/Coast_Plots_Used_Morethan_Once.csv")
###Summaries by BGC and by SS
#plots_bgc <- SU %>% group_by(bgc) %>% dplyr::summarise(plots = n())
plots_SS <- SU %>% group_by(SiteUnit) %>% dplyr::summarise(plots = n())
SS_count <- length(unique(SU$SiteUnit))
siteunits_toofew <- plots_SS %>% filter(plots <5) #%>% dplyr::select(- PlotNumber) %>% distinct

fwrite(siteunits_toofew, "./outputs/Coast_SiteUnits_w_lessthan5plots.csv")
```

##roll up into site series summary data and reduce to analysis set
```{r summarize site series, echo=FALSE}
### test run without non-vasculars
vegdata2 <- vegdata %>% filter(lifeform <9 | lifeform == 12)

source("./_functions/_lump_species.R")
vegdata2 <- lump_species(vegdata2, LUMP)

#vegdata <- vegdata %>% filter(lifeform <3)
source("./_functions/_create_su_vegdata.R")
vegsum <- create_su_vegdata(vegdata2, SU)
#vegsum <- vegsum %>% filter(SiteUnit %in% c("CWH vm 2 /110", "CWH vm 3 /110"), !Species %in% c("PTERAQU"))
source("./_functions/_create_analysis_vegsum.R")
veg_anal <- create_analysis_vegsum (vegsum, importance = 0.5, constancy = 55, minplots = 5)

save(veg_anal, file = "./clean_data/SS_sum_analysis.RData")

fwrite(veg_anal, "./outputs/Coast_SiteUnits_w_lessthan5plots.csv")
SS_reduced_list <- unique(veg_anal$SiteUnit) %>% as.data.frame %>% dplyr::rename(SS = 1)
SU_reduced <- SU %>% filter(SiteUnit %in% SS_reduced_list$SS)
```

Cluster of site units to create associations.
Uses the reduced species set and sets an  distance cut-off that seems to equate to association
Need to test against the pairwise routine.

```{r create distance matrix}
require(harrietr)
veg.dat <-
  veg_anal %>% dplyr::select(SiteUnit, Species, spp_importance) %>% matrify()
# test_jac.vegan <- vegan::vegdist(test.data, method = "sorensen", binary = F) %>% as.matrix
#test_jac <- philentropy::distance(test.data, method = "jaccard")
test_jac <- proxy::dist(veg.dat, method="ejaccard", diag=TRUE, upper = FALSE) ## ejaccard and philentropy jaccard are real-data versions extended jaccard opr taimoto
# xx <- as.matrix(test_jac)
# units <- as.data.frame(rownames(xx))

# , use.row.names = TRUE, as.dist.obj = TRUE)
test_jac.tab <- test_jac %>% as.matrix %>% as.data.frame
test_jac.list <- harrietr::melt_dist(test_jac.tab) %>% as.data.table #%>% filter(dist < .25)
minimum.iso1 <- test_jac.list %>% group_by(iso1) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% dplyr::select(iso1) %>% dplyr::rename(SS = iso1)
minimum.iso2 <- test_jac.list %>% group_by(iso2) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% dplyr::select(iso2) %>% dplyr::rename(SS = iso2)
SS_w_neighbours <- rbind(minimum.iso1,  minimum.iso2) %>% unique
SS_no_neighbours <- anti_join(SS_reduced_list, SS_w_neighbours)
fwrite(test_jac.tab, "./outputs/dissim_matrix1.csv")
fwrite(test_jac.list, "./outputs/dissim_pairwise1.csv")
fwrite(SS_no_neighbours, "./outputs/SS_with_no_similar1.csv")
```


```{r merge very similar units}
test_jac.list2 <- test_jac.list %>% rename(iso2 = 1, iso1 = 2) %>% select(iso1, everything())
test_jac.list <- rbind(test_jac.list, test_jac.list2)
setDT(test_jac.list)[ , .SD[which.min(dist)], by = iso1]
automerge <- test_jac.list %>% filter(dist < .075) %>% mutate(SiteUnit_new = paste0(pmin(iso1,iso2),"-",  pmax(iso1,iso2))) %>% arrange(dist) %>% distinct %>% rename(SiteUnit = iso1)
### need to flag which site units have already been used in a unit 

#%>% distinct(iso1, .keep_all = TRUE) %>% select(-iso2) 
# automerge1 <- test_jac.list %>% filter(dist < .15) %>% mutate(SiteUnit_new = paste0(iso1, "-", iso2)) %>% arrange(dist) %>% distinct(iso2, .keep_all = TRUE)%>% select(-iso1) %>% rename(SiteUnit = iso2)
# automerge2 <- rbind(automerge, automerge1) %>% arrange(dist) %>% distinct(SiteUnit, .keep_all = TRUE)
fwrite(automerge, "./outputs/first_merge_lowdiss_units.csv")
SU2 = SU
setDT(SU2)[automerge, "SiteUnit" := SiteUnit_new, on = .(SiteUnit)]

```

```{r round 2 merge together very similar}
vegsum <- create_su_vegdata(vegdata2, SU2)

source("./_functions/_create_analysis_vegsum.R")
veg_anal <- create_analysis_vegsum (vegsum, importance = 0.5, constancy = 60, minplots = 5)

veg.dat <-
  veg_anal %>% dplyr::select(SiteUnit, Species, spp_importance) %>% matrify()
# test_jac.vegan <- vegan::vegdist(test.data, method = "sorensen", binary = F) %>% as.matrix
#test_jac <- philentropy::distance(test.data, method = "jaccard")
test_jac <- proxy::dist(veg.dat, method="ejaccard", diag=TRUE, upper = FALSE) ## ejaccard and philentropy jaccard are real-data versions extended jaccard opr taimoto
# xx <- as.matrix(test_jac)
# units <- as.data.frame(rownames(xx))

# , use.row.names = TRUE, as.dist.obj = TRUE)
test_jac.tab <- test_jac %>% as.matrix %>% as.data.frame
test_jac.list <- harrietr::melt_dist(test_jac.tab) %>% as.data.table #%>% filter(dist < .25)
minimum.iso1 <- test_jac.list %>% group_by(iso1) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso1) %>% dplyr::rename(SS = iso1)
minimum.iso2 <- test_jac.list %>% group_by(iso2) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso2) %>% dplyr::rename(SS = iso2)
SS_w_neighbours <- rbind(minimum.iso1,  minimum.iso2) %>% unique
SS_no_neighbours <- anti_join(SS_reduced_list, SS_w_neighbours)
test_jac.list2 <- test_jac.list %>% rename(iso2 = 1, iso1 = 2) %>% select(iso1, everything())
test_jac.list <- rbind(test_jac.list, test_jac.list2)
setDT(test_jac.list)[ , .SD[which.min(dist)], by = iso1]
automerge <- test_jac.list %>% filter(dist < .075) %>% mutate(SiteUnit_new = paste0(pmin(iso1,iso2),"-",  pmax(iso1,iso2))) %>% arrange(dist) %>% distinct %>% rename(SiteUnit = iso1)
fwrite(test_jac.tab, "./outputs/dissim_matrix2.csv")
fwrite(test_jac.list, "./outputs/dissim_pairwise2.csv")
fwrite(SS_no_neighbours, "./outputs/SS_with_no_similar2.csv")

#%>% distinct(iso1, .keep_all = TRUE) %>% select(-iso2) 
# automerge1 <- test_jac.list %>% filter(dist < .15) %>% mutate(SiteUnit_new = paste0(iso1, "-", iso2)) %>% arrange(dist) %>% distinct(iso2, .keep_all = TRUE)%>% select(-iso1) %>% rename(SiteUnit = iso2)
# automerge2 <- rbind(automerge, automerge1) %>% arrange(dist) %>% distinct(SiteUnit, .keep_all = TRUE)
fwrite(automerge, "./outputs/first_merge_lowdiss_units.csv")
SU3 = SU2
setDT(SU3)[automerge, "SiteUnit" := SiteUnit_new, on = .(SiteUnit)]
```

```{r round 3}
vegsum <- create_su_vegdata(vegdata2, SU3)

souvegsum <- create_su_vegdata(vegdata2, SU3)

source("./_functions/_create_analysis_vegsum.R")
veg_anal <- create_analysis_vegsum (vegsum, importance = 0.5, constancy = 60, minplots = 5)

veg.dat <-
  veg_anal %>% dplyr::select(SiteUnit, Species, spp_importance) %>% matrify()
# test_jac.vegan <- vegan::vegdist(test.data, method = "sorensen", binary = F) %>% as.matrix
#test_jac <- philentropy::distance(test.data, method = "jaccard")
test_jac <- proxy::dist(veg.dat, method="ejaccard", diag=TRUE, upper = FALSE) ## ejaccard and philentropy jaccard are real-data versions extended jaccard opr taimoto
# xx <- as.matrix(test_jac)
# units <- as.data.frame(rownames(xx))

# , use.row.names = TRUE, as.dist.obj = TRUE)
test_jac.tab <- test_jac %>% as.matrix %>% as.data.frame
test_jac.list <- harrietr::melt_dist(test_jac.tab) %>% as.data.table #%>% filter(dist < .25)
minimum.iso1 <- test_jac.list %>% group_by(iso1) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso1) %>% dplyr::rename(SS = iso1)
minimum.iso2 <- test_jac.list %>% group_by(iso2) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso2) %>% dplyr::rename(SS = iso2)
SS_w_neighbours <- rbind(minimum.iso1,  minimum.iso2) %>% unique
SS_no_neighbours <- anti_join(SS_reduced_list, SS_w_neighbours)
test_jac.list2 <- test_jac.list %>% rename(iso2 = 1, iso1 = 2) %>% select(iso1, everything())
test_jac.list <- rbind(test_jac.list, test_jac.list2)
setDT(test_jac.list)[ , .SD[which.min(dist)], by = iso1]
automerge <- test_jac.list %>% filter(dist < .vegsum <- create_su_vegdata(vegdata2, SU3))

source("./_functions/_create_analysis_vegsum.R")
veg_anal <- create_analysis_vegsum (vegsum, importance = 0.5, constancy = 60, minplots = 5)

veg.dat <-
  veg_anal %>% dplyr::select(SiteUnit, Species, spp_importance) %>% matrify()
# test_jac.vegan <- vegan::vegdist(test.data, method = "sorensen", binary = F) %>% as.matrix
#test_jac <- philentropy::distance(test.data, method = "jaccard")
test_jac <- proxy::dist(veg.dat, method="ejaccard", diag=TRUE, upper = FALSE) ## ejaccard and philentropy jaccard are real-data versions extended jaccard opr taimoto
# xx <- as.matrix(test_jac)
# units <- as.data.frame(rownames(xx))

# , use.row.names = TRUE, as.dist.obj = TRUE)
test_jac.tab <- test_jac %>% as.matrix %>% as.data.frame
test_jac.list <- harrietr::melt_dist(test_jac.tab) %>% as.data.table #%>% filter(dist < .25)
minimum.iso1 <- test_jac.list %>% group_by(iso1) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso1) %>% dplyr::rename(SS = iso1)
minimum.iso2 <- test_jac.list %>% group_by(iso2) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso2) %>% dplyr::rename(SS = iso2)
SS_w_neighbours <- rbind(minimum.iso1,  minimum.iso2) %>% unique
SS_no_neighbours <- anti_join(SS_reduced_list, SS_w_neighbours)
test_jac.list2 <- test_jac.list %>% rename(iso2 = 1, iso1 = 2) %>% select(iso1, everything())
test_jac.list <- rbind(test_jac.list, test_jac.list2)
setDT(test_jac.list)[ , .SD[which.min(dist)], by = iso1]
#automerge <- test_jac.list %>% filter(dist < .
# units <- as.data.frame(rownames(xx))

# , use.row.names = TRUE, as.dist.obj = TRUE)
test_jac.tab <- test_jac %>% as.matrix %>% as.data.frame
test_jac.list <- harrietr::melt_dist(test_jac.tab) %>% as.data.table #%>% filter(dist < .25)
minimum.iso1 <- test_jac.list %>% group_by(iso1) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso1) %>% dplyr::rename(SS = iso1)
minimum.iso2 <- test_jac.list %>% group_by(iso2) %>%  slice_min(order_by = dist) %>% filter(dist<.2) %>% select(iso2) %>% dplyr::rename(SS = iso2)
SS_w_neighbours <- rbind(minimum.iso1,  minimum.iso2) %>% unique
SS_no_neighbours <- anti_join(SS_reduced_list, SS_w_neighbours)
test_jac.list2 <- test_jac.list %>% rename(iso2 = 1, iso1 = 2) %>% select(iso1, everything())
test_jac.list <- rbind(test_jac.list, test_jac.list2)
setDT(test_jac.list)[ , .SD[which.min(dist)], by = iso1]
automerge <- test_jac.list %>% filter(dist < .15) # %>% mutate(SiteUnit_new = paste0(pmin(iso1,iso2),"-",  pmax(iso1,iso2))) %>% arrange(dist) %>% distinct %>% rename(SiteUnit = iso1)

fwrite(test_jac.tab, "./outputs/dissim_matrix3.csv")
fwrite(test_jac.list, "./outputs/dissim_pairwise3.csv")
fwrite(SS_no_neighbours, "./outputs/SS_with_no_similar3.csv")

#%>% distinct(iso1, .keep_all = TRUE) %>% select(-iso2) 
# automerge1 <- test_jac.list %>% filter(dist < .15) %>% mutate(SiteUnit_new = paste0(iso1, "-", iso2)) %>% arrange(dist) %>% distinct(iso2, .keep_all = TRUE)%>% select(-iso1) %>% rename(SiteUnit = iso2)
# automerge2 <- rbind(automerge, automerge1) %>%) %>% mutate(SiteUnit_new = paste0(pmin(iso1,iso2),"-",  pmax(iso1,iso2))) %>% arrange(dist) %>% distinct %>% rename(SiteUnit = iso1)

fwrite(test_jac.tab, "./outputs/dissim_matrix3.csv")
fwrite(test_jac.list, "./outputs/dissim_pairwise3.csv")
fwrite(SS_no_neighbours, "./outputs/SS_with_no_similar3.csv")

#%>% distinct(iso1, .keep_all = TRUE) %>% select(-iso2) 
# automerge1 <- test_jac.list %>% filter(dist < .15) %>% mutate(SiteUnit_new = paste0(iso1, "-", iso2)) %>% arrange(dist) %>% distinct(iso2, .keep_all = TRUE)%>% select(-iso1) %>% rename(SiteUnit = iso2)
# automerge2 <- rbind(automerge, automerge1) %>% arrange(dist) %>% distinct(SiteUnit, .keep_all = TRUE)
fwrite(automerge, "./outputs/first_merge_lowdiss_units.csv")
SU4 = SU3
setDT(SU4)[automerge, "SiteUnit" := SiteUnit_new, on = .(SiteUnit)]
library(cluster)
ss_clst = agnes(test_jac, diss = TRUE, stand = FALSE,
      method = "complete")
ht_dendro <- max(ss_clst$height)*.25
dendro_test =as.dendrogram(ss_clst)
plot(dendro_test)

par(mfrow=c(3,1))

plot(dendro_test, main="Main")
plot(cut(dendro_test, h = ht_dendro)$upper,
     main="Upper tree of cut at h=25")
plot(cut(dendro_test, h = ht_dendro)$lower[[4]],
     main="Second branch of lower tree with cut at h=25")

 orders <- cutree(as.hclust(ss_clst), h=ht_dendro)
 order_SU <- as.data.frame(orders) %>% rownames_to_column("SiteUnit")# %>% mutate(working = paste0("working-", orders))
 order_SU <- left_join(SU, order_SU, by = "SiteUnit")
 groups <- order_SU %>% column_to_rownames("PlotNumber") %>% dplyr::select(orders) %>% t

 fwrite(order_SU, "./outputs/working_SU.csv")
```
The cut-offs representing each level are approximate. Really only the lowest level c
```{r cut cluster }
 working <- cutree(as.hclust(ss_clst),h =.25)
alliances <- cutree(as.hclust(ss_clst), h=1)
 suborders <- cutree(as.hclust(ss_clst), h=1)
 orders <- cutree(as.hclust(ss_clst), h=1)
# k = length(unique(working))
# k2 <- length(unique(alliances))
# k3 <- length(unique(suborders))
# k4 <- length(unique(orders))
# ss_dend <- fviz_dend (ss_clst , k=k4, color_labels_by_k = T, lwd = .5, rect = T, cex = .5, horiz = T) %>%    plot()
  # 
working_SU <- as.data.frame(working) %>% rownames_to_column("SiteUnit") %>% mutate(working = paste0("workgrp-", working))
working_SS <- left_join(SU, working_SU, by = "SiteUnit") %>% dplyr::select (SiteUnit, working) %>% distinct %>% drop_na
# %>% arrange(desc(PlotNumber))
alliance_SU <- as.data.frame(alliances) %>% rownames_to_column("SiteUnit") %>% mutate(alliances = paste0("alliance-", alliances))
suborder_SU <- as.data.frame(suborders) %>% rownames_to_column("SiteUnit") %>% mutate(suborders = paste0("suborder-", suborders))
newsuborder <- unique(suborder_SU$suborders)
order_SU <- as.data.frame(orders) %>% rownames_to_column("SiteUnit") %>% mutate(orders = paste0("order-", orders))
#order_SU <- order_SU %>% mutate(orders = ifelse((orders %in% fewplots$x), "Unplaced", orders))
#neworder <- unique(order_SU$orders)

Hier_SU <- left_join(SU, working_SU, by = "SiteUnit") %>% 
left_join(alliance_SU, by = "SiteUnit") %>% 
  left_join(suborder_SU, by = "SiteUnit") %>% 
  left_join(order_SU, by = "SiteUnit") %>% distinct() %>% drop_na()
working_count <- length(unique(Hier_SU$working))
grouped_SS <- Hier_SU %>% select(SiteUnit, working) %>% distinct
grouped_Assocs <- grouped_SS %>% select(working) %>% distinct

ss_count <- length(unique(Hier_SU$SiteUnit))
fwrite(Hier_SU, "./outputs/SIFR_ForestClusteredUnits_SU.csv")

```

Build a Vpro hierachy style to be copied into a copy of the sample hier and then save as to a real hierarchy where the ID can be turned back into an autonumber for proper working of Vpro hierarchy functions

```{r Convert to hierarchy}
Hier.new <- Hier_SU %>% mutate(formation = "-", class = "-", suball = "-", subass = "-", facies = "-", assocs = "-") %>%   
  dplyr::select(formation, class, orders, suborders,alliances, suball, assocs, subass, facies, working, SiteUnit) %>% 
  distinct()
Hier.new  <- Hier.new  %>% mutate(class = ifelse(is.na(working), "unplaced", "placed" ))
#Hier.new <- fread("./outputs/BECv13_Hierarchy_Matrix.csv")
 levelNames <- c("formation", "class", "orders", "suborders", "alliances", "suball", "assocs", "subass", "facies", "working", "SiteUnit")
Hier.new <- as.data.table(Hier.new)
testReverse <- tableToTree(hierWide = copy(Hier.new),levelNames)
testReverse$Parent <- ifelse(testReverse$Parent == 1, "", testReverse$Parent)
fwrite(testReverse, "./outputs/SIFRForestHierarchyTreev2.csv")
```

####______________SOME OTHER TESTS_______________________

Build assocs in two steps. Build an initial very similar set and then cluster the initial cluster again
```{r cutree}

 assocs <- cutree(as.hclust(ss_clst),h =.25)
 assoc_SU <- as.data.frame(assocs) %>% rownames_to_column("SiteUnit") %>% mutate(assocs = paste0("working-", assocs))
assoc_SS <- left_join(SU_reduced, assoc_SU, by = "SiteUnit") %>% dplyr::select (SiteUnit, assocs) %>% distinct %>% drop_na
count_assocs <- length(unique(assoc_SS$assocs))
```
Repeat cluster with first round working and look for similar

```{r rebuild the hierarchy using the new assoc as the root}
SU2 <- left_join(SU_reduced, assoc_SU) %>% dplyr::rename(siteseries = SiteUnit, SiteUnit = assocs)

source("./_functions/_create_su_vegdata.R")
vegsum <- create_su_vegdata(vegdata, SU2)

source("./_functions/_create_analysis_vegsum.R")
veg_anal <- create_analysis_vegsum (vegsum, importance = 0.5, constancy = 60, minplots = 5)

veg.dat <-
  veg_anal %>% dplyr::select(SiteUnit, Species, spp_importance) %>% matrify()
# test_jac.vegan <- vegan::vegdist(test.data, method = "sorensen", binary = F) %>% as.matrix
#test_jac <- philentropy::distance(test.data, method = "jaccard")
test_jac <- proxy::dist(veg.dat, method="ejaccard", diag=TRUE, upper = TRUE)
ss_clst2 = agnes(test_jac, diss = TRUE, stand = FALSE,
      method = "complete")
 assocs2 <- cutree(as.hclust(ss_clst2),h =.25)
 assoc_SS2 <- as.data.frame(assocs2) %>% rownames_to_column("SiteUnit") %>% mutate(assocs2 = paste0("assoc-", assocs2)) %>% dplyr::rename(assocs = SiteUnit)
 assoc_SU2 <- left_join(assoc_SU, assoc_SS2, by = "assocs")
 SU3 <- SU2 %>% dplyr::rename(assocs = SiteUnit, SiteUnit = siteseries) %>% dplyr::select(-assocs)
assoc_SU2 <- left_join(SU3, assoc_SU2, by = "SiteUnit") %>% dplyr::select (PlotNumber, SiteUnit, assocs, assocs2) %>% dplyr::rename(working = assocs, assocs = assocs2) %>% distinct %>% drop_na
assoc_SS2 <- assoc_SU2 %>% dplyr::select (-PlotNumber) %>% distinct %>% drop_na
count_assocs2 <- length(unique(assoc_SS2$assocs))
#Hier_SU <- Hier_SU %>% dplyr::select(-assocs)
assoc_SU2 <- assoc_SU2 %>% dplyr::select(SiteUnit, assocs)
Hier_SU2 <- left_join(Hier_SU, assoc_SU2, by = "SiteUnit")

# working <- cutree(as.hclust(ss_clst),h =.25)
# alliances <- cutree(as.hclust(ss_clst), h=.5)
#  suborders <- cutree(as.hclust(ss_clst), h=.80)
#  orders <- cutree(as.hclust(ss_clst), h=1)
#   # 
# alliance_SU <- as.data.frame(alliances) %>% rownames_to_column("SiteUnit") %>% mutate(alliances = paste0("alliance-", alliances))
# suborder_SU <- as.data.frame(suborders) %>% rownames_to_column("SiteUnit") %>% mutate(suborders = paste0("suborder-", suborders))
# newsuborder <- unique(suborder_SU$suborders)
# order_SU <- as.data.frame(orders) %>% rownames_to_column("SiteUnit") %>% mutate(orders = paste0("order-", orders))
# #order_SU <- order_SU %>% mutate(orders = ifelse((orders %in% fewplots$x), "Unplaced", orders))
# #neworder <- unique(order_SU$orders)

Hier_SU2 <- left_join(assoc_SU2, alliance_SU, by = "SiteUnit") %>% 
  left_join(suborder_SU, by = "SiteUnit") %>% 
  left_join(order_SU, by = "SiteUnit") %>% distinct() %>% drop_na()

fwrite(Hier_SU, "./outputs/CoastForest2stepClusteredUnits_SU.csv")
```

```{r rebuild the hierarchy using the new assoc as the root}
Hier.new <- Hier_SU2 %>% mutate(formation = "-", class = "-", suball = "-", subass = "-", facies = "-") %>%   
  dplyr::select(formation, class, orders, suborders,alliances, suball, assocs, subass, facies, working, SiteUnit) %>% 
  distinct()
Hier.new  <- Hier.new  %>% mutate(class = ifelse(is.na(working), "unplaced", "placed" ))
#Hier.new <- fread("./outputs/BECv13_Hierarchy_Matrix.csv")
 levelNames <- c("formation", "class", "orders", "suborders", "alliances", "suball", "assocs", "subass", "facies", "working", "SiteUnit")
Hier.new <- as.data.table(Hier.new)
testReverse <- tableToTree(hierWide = copy(Hier.new),levelNames)
testReverse$Parent <- ifelse(testReverse$Parent == 1, "", testReverse$Parent)
fwrite(testReverse, "./outputs/CoastForestHierarchyTree2.csv")


```

Build groups iteratively merging pairs of units with the minimum distance (and <.20) and add an assoc column to SU table for each of the site series in the pair with an assoc number. Then recalculating veg_anal from the list of units a Set all site series to equivalent plot numbers. And iterate.
```{r novel grouping method}
# xx <- test_jac.list[ , .SD[which.min(dist)], by = iso2] %>% filter(dist < 0.2) %>% arrange(iso1)
# unit_list <- unique(xx$iso1) %>% data.frame
# xx[, ID := sequence(.N), by = iso1]
# xx[, change := shift(iso1) != iso1]
# xx[is.na(change), change := TRUE]
# xx[, res := cumsum(change)]
# 
# xx1 <- xx %>% dplyr::select(iso1, res) %>% rename(SiteUnit = 1) %>% distinct
# xx2 <- xx %>% dplyr::select(iso2, res) %>% rename(SiteUnit = 1) %>% distinct
# xx_all <- rbind(xx1, xx2)
```


